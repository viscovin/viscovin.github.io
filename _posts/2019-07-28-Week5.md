---
layout: post
title: Week 5
---
# Windows Internals
## Memory Manipulation 
### Rootkits 
- Malware that actively conceals its existence and actions from users and system processes.
- Approximately 10% of current malware use rootkit
- Rootkits are most prevalent in 32 bit Windows
- Handful of families so far for 64 bit
- Rootkits are one of the best way to learn about kernel security challenges.

**Challenges once malicious code enters kernel**
- Harder for rootkits to enter 64 bit kernel
- Rootkits can infiltrate 64 bit OS Kernel by
  a) Bypassing driver signing check (e.g. using testsigning mode)
  b) Modifying the windows boot path (MBR etc) â€“ Secure boot prevents this.
  c) Kernel exploits in Windows kernel  or third party drivers.
  d) Stealing valid digisigs (Similar to Stuxnet)

**Kernal Memory**
- Is a flat memory model with no security separation. 
- Any kernel driver can access any part of memory. 
- Composed of windows kernel (ntoskrnl.exe) as well as driver code. 
- Many important structures that are prime targets for stealth. SSDT, IRP, IDT etc. 
- Windbg commands: .process command, lm, !devobj, !drvobj, !devstack, !irp etc. Virtual to physical memory etc.

### Lab: Rootkit Agony Analysis
**Instructions** 
- Extract and copy file from C:\Users\Admin\Desktop\malware\WindowsInternals\Agony.zip  to \Desktop\bad (no extension)
- Run FakeNet
- Run Cuckoo

<img src= "https://raw.githubusercontent.com/viscovin/viscovin.github.io/master/images/agony1.JPG">

Files found in Cuckoo where:
- bad.bin
- tzres.dll.bin
- tzres.dll.mui.bin
- sortdefault.nls.bin

After running Tuluka and dir \*.sys on CMD we see hidden file created 

<img src= "https://raw.githubusercontent.com/viscovin/viscovin.github.io/master/images/agony2.JPG">
